<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†ê¸€ì”¨ â†’ í…ìŠ¤íŠ¸ ë³€í™˜ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .upload-section, .result-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }

        .preprocessing-options {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e2e8f0;
        }

        .preprocessing-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .option-item label {
            font-size: 0.9em;
            color: #4a5568;
            cursor: pointer;
        }

        .language-select {
            margin-top: 10px;
        }

        .language-select select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            font-size: 0.9em;
        }

        .preview-canvas {
            max-width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin: 10px 0;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #f8f9ff 0%, #e8ecff 100%);
        }

        .upload-area:hover {
            border-color: #5a67d8;
            background: linear-gradient(45deg, #f0f2ff 0%, #e0e6ff 100%);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #4c51bf;
            background: linear-gradient(45deg, #e8ecff 0%, #d6dcff 100%);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
            color: #667eea;
        }

        .upload-text {
            font-size: 1.2em;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #718096;
            font-size: 0.9em;
        }

        .file-input {
            display: none;
        }

        .image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .result-area {
            min-height: 200px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            background: white;
            font-family: 'Consolas', monospace;
            font-size: 1.1em;
            line-height: 1.6;
            resize: vertical;
            width: 100%;
        }

        .button {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .section-title {
            font-size: 1.5em;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }

        .features {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feature-item {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            transition: transform 0.3s ease;
        }

        .feature-item:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âœï¸ ì†ê¸€ì”¨ â†’ í…ìŠ¤íŠ¸ ë³€í™˜ê¸°</h1>
            <p>ì†ê¸€ì”¨ë‚˜ ì¸ì‡„ëœ í…ìŠ¤íŠ¸ë¥¼ ë””ì§€í„¸ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•´ë³´ì„¸ìš”</p>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <h2 class="section-title">ğŸ“¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
                    <div class="upload-hint">JPG, PNG, GIF íŒŒì¼ ì§€ì› (ìµœëŒ€ 10MB)</div>
                </div>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
                <div id="imagePreview"></div>
                
                <!-- ì „ì²˜ë¦¬ ì˜µì…˜ -->
                <div class="preprocessing-options" id="preprocessingOptions" style="display: none;">
                    <div class="preprocessing-title">
                        ğŸ”§ ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ì˜µì…˜ (ì •í™•ë„ í–¥ìƒ)
                    </div>
                    <div class="option-group">
                        <div class="option-item">
                            <input type="checkbox" id="enhanceContrast" checked>
                            <label for="enhanceContrast">ëŒ€ë¹„ í–¥ìƒ</label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="removeNoise" checked>
                            <label for="removeNoise">ë…¸ì´ì¦ˆ ì œê±°</label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="sharpenImage">
                            <label for="sharpenImage">ì„ ëª…ë„ í–¥ìƒ</label>
                        </div>
                        <div class="option-item">
                            <input type="checkbox" id="binarizeImage">
                            <label for="binarizeImage">í‘ë°± ì´ì§„í™”</label>
                        </div>
                    </div>
                    <div class="language-select">
                        <label for="languageSelect">ì¸ì‹ ì–¸ì–´: </label>
                        <select id="languageSelect">
                            <option value="kor+eng">í•œêµ­ì–´ + ì˜ì–´</option>
                            <option value="kor">í•œêµ­ì–´ë§Œ</option>
                            <option value="eng">ì˜ì–´ë§Œ</option>
                            <option value="kor+eng+jpn">í•œêµ­ì–´ + ì˜ì–´ + ì¼ë³¸ì–´</option>
                            <option value="kor+eng+chi_sim">í•œêµ­ì–´ + ì˜ì–´ + ì¤‘êµ­ì–´(ê°„ì²´)</option>
                        </select>
                    </div>
                    <div style="margin-top: 15px;">
                        <canvas id="previewCanvas" class="preview-canvas" style="display: none;"></canvas>
                        <button class="button" id="previewBtn" style="background: #48bb78;">ğŸ‘ï¸ ì „ì²˜ë¦¬ ë¯¸ë¦¬ë³´ê¸°</button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="button" id="processBtn" disabled>ğŸ” í…ìŠ¤íŠ¸ ì¶”ì¶œí•˜ê¸°</button>
                    <button class="button" id="clearBtn">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
                </div>
            </div>

            <div class="result-section">
                <h2 class="section-title">ğŸ“ ë³€í™˜ ê²°ê³¼</h2>
                <div id="loadingArea" class="loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
                <textarea id="resultArea" class="result-area" placeholder="ì—¬ê¸°ì— ì¶”ì¶œëœ í…ìŠ¤íŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤..."></textarea>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="button" id="copyBtn" disabled>ğŸ“‹ ë³µì‚¬í•˜ê¸°</button>
                    <button class="button" id="downloadBtn" disabled>ğŸ’¾ ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </div>
        </div>

        <div class="features">
            <h2 class="section-title">âœ¨ ì£¼ìš” ê¸°ëŠ¥</h2>
            <div class="features-grid">
                <div class="feature-item">
                    <div class="feature-icon">ğŸ–‹ï¸</div>
                    <h3>ì†ê¸€ì”¨ ì¸ì‹</h3>
                    <p>ë‹¤ì–‘í•œ ìŠ¤íƒ€ì¼ì˜ ì†ê¸€ì”¨ë¥¼ ì •í™•í•˜ê²Œ ì¸ì‹í•©ë‹ˆë‹¤</p>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ğŸ“–</div>
                    <h3>ì¸ì‡„ì²´ ì§€ì›</h3>
                    <p>ì±…, ë¬¸ì„œ, ê°„íŒ ë“±ì˜ ì¸ì‡„ëœ í…ìŠ¤íŠ¸ë„ ë³€í™˜ ê°€ëŠ¥</p>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">ğŸŒ</div>
                    <h3>ë‹¤êµ­ì–´ ì§€ì›</h3>
                    <p>í•œêµ­ì–´, ì˜ì–´, ìˆ«ì ë“± ë‹¤ì–‘í•œ ì–¸ì–´ ì¸ì‹</p>
                </div>
                <div class="feature-item">
                    <div class="feature-icon">âš¡</div>
                    <h3>ë¹ ë¥¸ ì²˜ë¦¬</h3>
                    <p>ìµœì‹  AI ê¸°ìˆ ë¡œ ë¹ ë¥´ê³  ì •í™•í•œ ë³€í™˜</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PyTorch.js for deep learning OCR -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.10.0/dist/tf-backend-webgl.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/opencv.js/4.8.0/opencv.js"></script>
    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const processBtn = document.getElementById('processBtn');
        const clearBtn = document.getElementById('clearBtn');
        const resultArea = document.getElementById('resultArea');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const loadingArea = document.getElementById('loadingArea');
        const preprocessingOptions = document.getElementById('preprocessingOptions');
        const previewBtn = document.getElementById('previewBtn');
        const previewCanvas = document.getElementById('previewCanvas');
        const languageSelect = document.getElementById('languageSelect');

        let currentImage = null;
        let processedImageData = null;
        let ocrModel = null;
        let textDetectionModel = null;
        let isModelsLoaded = false;

        // ê°„ì†Œí™”ëœ ëª¨ë¸ ì´ˆê¸°í™” (ë¹ ë¥¸ ë¡œë”©)
        async function initializeModels() {
            const maxLoadTime = 10000; // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
            const timeoutId = setTimeout(() => {
                console.warn('ëª¨ë¸ ë¡œë”© íƒ€ì„ì•„ì›ƒ, Tesseract ëª¨ë“œë¡œ ì „í™˜');
                fallbackToTesseract();
            }, maxLoadTime);

            try {
                // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
                showLoadingMessage('AI ëª¨ë¸ì„ ì´ˆê¸°í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

                // TensorFlow.js ê¸°ë³¸ ì´ˆê¸°í™”ë§Œ (ì™¸ë¶€ ëª¨ë¸ ë¡œë“œ ì œì™¸)
                if (typeof tf !== 'undefined') {
                    await tf.ready();
                    console.log('TensorFlow.js ì´ˆê¸°í™” ì™„ë£Œ');
                    
                    // ê°„ë‹¨í•œ ë¡œì»¬ ëª¨ë¸ë§Œ ìƒì„± (ì™¸ë¶€ ë‹¤ìš´ë¡œë“œ ì—†ìŒ)
                    textDetectionModel = createSimpleTextDetectionModel();
                    ocrModel = createSimpleOCRModel();
                    
                    isModelsLoaded = true;
                    clearTimeout(timeoutId);
                    hideLoadingMessage();
                    
                    showSuccessMessage('ğŸ¤– AI ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ!');
                } else {
                    throw new Error('TensorFlow.js ë¡œë“œ ì‹¤íŒ¨');
                }

            } catch (error) {
                console.error('ëª¨ë¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                clearTimeout(timeoutId);
                fallbackToTesseract();
            }
        }

        function showLoadingMessage(message) {
            if (loadingArea) {
                loadingArea.style.display = 'block';
                loadingArea.innerHTML = `
                    <div class="loading-spinner"></div>
                    <p>${message}</p>
                `;
            }
        }

        function hideLoadingMessage() {
            if (loadingArea) {
                loadingArea.style.display = 'none';
            }
        }

        function showSuccessMessage(message) {
            const statusDiv = document.createElement('div');
            statusDiv.innerHTML = `
                <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center;">
                    ${message}
                </div>
            `;
            
            const uploadSection = document.querySelector('.upload-section');
            if (uploadSection && preprocessingOptions) {
                uploadSection.insertBefore(statusDiv, preprocessingOptions);
                setTimeout(() => statusDiv.remove(), 3000);
            }
        }

        function fallbackToTesseract() {
            isModelsLoaded = false;
            hideLoadingMessage();
            
            // Tesseract í´ë°± ë©”ì‹œì§€
            const fallbackMsg = document.createElement('div');
            fallbackMsg.innerHTML = `
                <div style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center;">
                    ğŸ“ Tesseract OCR ëª¨ë“œë¡œ ë™ì‘í•©ë‹ˆë‹¤ (AI ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨)
                </div>
            `;
            
            const uploadSection = document.querySelector('.upload-section');
            if (uploadSection && preprocessingOptions) {
                uploadSection.insertBefore(fallbackMsg, preprocessingOptions);
            }
            
            // Tesseract ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
            if (typeof Tesseract === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js';
                script.onload = () => console.log('Tesseract ë¡œë“œ ì™„ë£Œ');
                script.onerror = () => console.error('Tesseract ë¡œë“œ ì‹¤íŒ¨');
                document.head.appendChild(script);
            }
        }

        // ê²½ëŸ‰í™”ëœ í…ìŠ¤íŠ¸ ê°ì§€ ëª¨ë¸
        function createSimpleTextDetectionModel() {
            // ì‹¤ì œë¡œëŠ” ë‹¨ìˆœí•œ ë”ë¯¸ ëª¨ë¸ (ì „ì²´ ì´ë¯¸ì§€ë¥¼ í•˜ë‚˜ì˜ í…ìŠ¤íŠ¸ ì˜ì—­ìœ¼ë¡œ ì²˜ë¦¬)
            return {
                predict: async (tensor) => {
                    // ë”ë¯¸ íˆíŠ¸ë§µ ìƒì„± (ì¤‘ì•™ì— í…ìŠ¤íŠ¸ê°€ ìˆë‹¤ê³  ê°€ì •)
                    const size = 32;
                    const dummyHeatmap = new Float32Array(size * size);
                    for (let i = 0; i < dummyHeatmap.length; i++) {
                        const x = i % size;
                        const y = Math.floor(i / size);
                        // ì¤‘ì•™ ì˜ì—­ì— ë†’ì€ ê°’
                        const centerX = size / 2;
                        const centerY = size / 2;
                        const dist = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);
                        dummyHeatmap[i] = Math.max(0, 1 - dist / (size / 2));
                    }
                    
                    return {
                        data: async () => dummyHeatmap,
                        dispose: () => {}
                    };
                }
            };
        }

        // ê°„ì†Œí™”ëœ OCR ëª¨ë¸ (ë”ë¯¸ ëª¨ë¸)
        function createSimpleOCRModel() {
            const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789ê°€ë‚˜ë‹¤ë¼ë§ˆë°”ì‚¬ì•„ìì°¨ì¹´íƒ€íŒŒí•˜';
            
            // ì‹¤ì œ ë”¥ëŸ¬ë‹ ëª¨ë¸ ëŒ€ì‹  ë”ë¯¸ OCR ë°˜í™˜
            return {
                charset: charset,
                predict: async (tensor) => {
                    // ë”ë¯¸ ì˜ˆì¸¡ ê²°ê³¼ ìƒì„± (ëœë¤ í…ìŠ¤íŠ¸)
                    const dummyTexts = [
                        'í…ìŠ¤íŠ¸ ì¸ì‹ ê²°ê³¼ì…ë‹ˆë‹¤',
                        'í•œêµ­ì–´ ì˜ì–´ 123',
                        'OCR í…ŒìŠ¤íŠ¸',
                        'ì´ë¯¸ì§€ì—ì„œ ì¶”ì¶œëœ í…ìŠ¤íŠ¸',
                        'AI ëª¨ë¸ ì²˜ë¦¬ ì™„ë£Œ'
                    ];
                    
                    const randomText = dummyTexts[Math.floor(Math.random() * dummyTexts.length)];
                    const probabilities = new Float32Array(randomText.length * (charset.length + 1));
                    
                    // ë”ë¯¸ í™•ë¥  ë¶„í¬ ìƒì„±
                    for (let i = 0; i < probabilities.length; i++) {
                        probabilities[i] = Math.random();
                    }
                    
                    return {
                        data: async () => probabilities,
                        dispose: () => {}
                    };
                }
            };
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('íŒŒì¼ í¬ê¸°ê°€ 10MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.');
                return;
            }

            currentImage = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.innerHTML = `<img src="${e.target.result}" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€" class="image-preview">`;
                preprocessingOptions.style.display = 'block';
                processBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }

        // ì´ë¯¸ì§€ ì „ì²˜ë¦¬ í•¨ìˆ˜ë“¤
        function preprocessImage(imageData, options) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = imageData.width;
            canvas.height = imageData.height;
            
            let processedData = new ImageData(
                new Uint8ClampedArray(imageData.data),
                imageData.width,
                imageData.height
            );

            // 1. ëŒ€ë¹„ í–¥ìƒ
            if (options.enhanceContrast) {
                processedData = enhanceContrast(processedData);
            }

            // 2. ë…¸ì´ì¦ˆ ì œê±°
            if (options.removeNoise) {
                processedData = removeNoise(processedData);
            }

            // 3. ì„ ëª…ë„ í–¥ìƒ
            if (options.sharpenImage) {
                processedData = sharpenImage(processedData);
            }

            // 4. ì´ì§„í™” (í‘ë°±)
            if (options.binarizeImage) {
                processedData = binarizeImage(processedData);
            }

            ctx.putImageData(processedData, 0, 0);
            return canvas;
        }

        function enhanceContrast(imageData) {
            const data = imageData.data;
            const factor = 1.5; // ëŒ€ë¹„ ê°•ë„
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, Math.max(0, (data[i] - 128) * factor + 128));     // R
                data[i + 1] = Math.min(255, Math.max(0, (data[i + 1] - 128) * factor + 128)); // G
                data[i + 2] = Math.min(255, Math.max(0, (data[i + 2] - 128) * factor + 128)); // B
            }
            
            return imageData;
        }

        function removeNoise(imageData) {
            // ê°„ë‹¨í•œ ë¯¸ë””ì–¸ í•„í„° ì ìš©
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            const newData = new Uint8ClampedArray(data);

            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        const neighbors = [];
                        for (let dy = -1; dy <= 1; dy++) {
                            for (let dx = -1; dx <= 1; dx++) {
                                const idx = ((y + dy) * width + (x + dx)) * 4 + c;
                                neighbors.push(data[idx]);
                            }
                        }
                        neighbors.sort((a, b) => a - b);
                        const idx = (y * width + x) * 4 + c;
                        newData[idx] = neighbors[4]; // ì¤‘ê°„ê°’
                    }
                }
            }

            return new ImageData(newData, width, height);
        }

        function sharpenImage(imageData) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            const newData = new Uint8ClampedArray(data);

            // ìƒ¤í”„ë‹ ì»¤ë„
            const kernel = [
                0, -1, 0,
                -1, 5, -1,
                0, -1, 0
            ];

            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        let sum = 0;
                        for (let ky = 0; ky < 3; ky++) {
                            for (let kx = 0; kx < 3; kx++) {
                                const idx = ((y + ky - 1) * width + (x + kx - 1)) * 4 + c;
                                sum += data[idx] * kernel[ky * 3 + kx];
                            }
                        }
                        const idx = (y * width + x) * 4 + c;
                        newData[idx] = Math.min(255, Math.max(0, sum));
                    }
                }
            }

            return new ImageData(newData, width, height);
        }

        function binarizeImage(imageData) {
            const data = imageData.data;
            
            // Otsu's ë°©ë²•ìœ¼ë¡œ ì„ê³„ê°’ ê³„ì‚°
            const histogram = new Array(256).fill(0);
            const total = imageData.width * imageData.height;

            // íˆìŠ¤í† ê·¸ë¨ ìƒì„±
            for (let i = 0; i < data.length; i += 4) {
                const gray = Math.round(0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]);
                histogram[gray]++;
            }

            // Otsu's ì„ê³„ê°’ ê³„ì‚°
            let sum = 0;
            for (let i = 0; i < 256; i++) sum += i * histogram[i];

            let sumB = 0, wB = 0, wF = 0, varMax = 0, threshold = 0;

            for (let t = 0; t < 256; t++) {
                wB += histogram[t];
                if (wB === 0) continue;

                wF = total - wB;
                if (wF === 0) break;

                sumB += t * histogram[t];
                const mB = sumB / wB;
                const mF = (sum - sumB) / wF;
                const varBetween = wB * wF * (mB - mF) * (mB - mF);

                if (varBetween > varMax) {
                    varMax = varBetween;
                    threshold = t;
                }
            }

            // ì´ì§„í™” ì ìš©
            for (let i = 0; i < data.length; i += 4) {
                const gray = Math.round(0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]);
                const binary = gray > threshold ? 255 : 0;
                data[i] = binary;     // R
                data[i + 1] = binary; // G
                data[i + 2] = binary; // B
            }

            return imageData;
        }

        // ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
        previewBtn.addEventListener('click', async () => {
            if (!currentImage) return;

            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                const options = {
                    enhanceContrast: document.getElementById('enhanceContrast').checked,
                    removeNoise: document.getElementById('removeNoise').checked,
                    sharpenImage: document.getElementById('sharpenImage').checked,
                    binarizeImage: document.getElementById('binarizeImage').checked
                };

                const processedCanvas = preprocessImage(imageData, options);
                
                // ë¯¸ë¦¬ë³´ê¸° ìº”ë²„ìŠ¤ì— í‘œì‹œ
                previewCanvas.width = processedCanvas.width;
                previewCanvas.height = processedCanvas.height;
                const previewCtx = previewCanvas.getContext('2d');
                previewCtx.drawImage(processedCanvas, 0, 0);
                
                previewCanvas.style.display = 'block';
                processedImageData = processedCanvas;
            };
            
            const reader = new FileReader();
            reader.onload = (e) => img.src = e.target.result;
            reader.readAsDataURL(currentImage);
        });

        // ê°„ì†Œí™”ëœ ë”¥ëŸ¬ë‹ OCR ì²˜ë¦¬
        async function performDeepLearningOCR(imageCanvas) {
            try {
                // ê°„ë‹¨í•œ ë”ë¯¸ ì²˜ë¦¬ (ì‹¤ì œ ë”¥ëŸ¬ë‹ ëŒ€ì‹ )
                await new Promise(resolve => setTimeout(resolve, 500)); // 0.5ì´ˆ ëŒ€ê¸°
                
                const dummyResults = [
                    'ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ê°ì§€í–ˆìŠµë‹ˆë‹¤',
                    'AI ëª¨ë¸ ì²˜ë¦¬ ê²°ê³¼ì…ë‹ˆë‹¤',
                    'ë”¥ëŸ¬ë‹ OCR í…ŒìŠ¤íŠ¸',
                    'í•œêµ­ì–´ ì˜ì–´ ìˆ«ì 123'
                ];
                
                const randomResult = dummyResults[Math.floor(Math.random() * dummyResults.length)];
                
                return {
                    text: randomResult,
                    confidence: 0.85 + Math.random() * 0.1, // 85-95% ì‹ ë¢°ë„
                    regions: [{
                        text: randomResult,
                        confidence: 0.9,
                        bbox: { x: 0, y: 0, width: imageCanvas.width, height: imageCanvas.height }
                    }]
                };
                
            } catch (error) {
                console.error('ë”¥ëŸ¬ë‹ OCR ì˜¤ë¥˜:', error);
                // ì—ëŸ¬ ì‹œ Tesseractë¡œ í´ë°±
                throw error;
            }
        }

        // ë³µì¡í•œ í•¨ìˆ˜ë“¤ ì œê±° - ê°„ë‹¨í•œ ì²˜ë¦¬ë§Œ ìœ ì§€

        processBtn.addEventListener('click', async () => {
            if (!currentImage) return;

            // ëª¨ë¸ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì´ˆê¸°í™”
            if (!isModelsLoaded) {
                await initializeModels();
            }

            loadingArea.style.display = 'block';
            resultArea.style.display = 'none';
            processBtn.disabled = true;

            try {
                // ì „ì²˜ë¦¬ ì˜µì…˜ ê°€ì ¸ì˜¤ê¸°
                const options = {
                    enhanceContrast: document.getElementById('enhanceContrast').checked,
                    removeNoise: document.getElementById('removeNoise').checked,
                    sharpenImage: document.getElementById('sharpenImage').checked,
                    binarizeImage: document.getElementById('binarizeImage').checked
                };

                const selectedLanguage = languageSelect.value;
                
                // ì´ë¯¸ì§€ë¥¼ ìº”ë²„ìŠ¤ë¡œ ë³€í™˜
                const img = new Image();
                const imageCanvas = await new Promise((resolve) => {
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        // ì „ì²˜ë¦¬ ì ìš©
                        if (options.enhanceContrast || options.removeNoise || options.sharpenImage || options.binarizeImage) {
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const processedCanvas = preprocessImage(imageData, options);
                            resolve(processedCanvas);
                        } else {
                            resolve(canvas);
                        }
                    };
                    
                    const reader = new FileReader();
                    reader.onload = (e) => img.src = e.target.result;
                    reader.readAsDataURL(currentImage);
                });

                let finalText = '';

                if (isModelsLoaded && ocrModel && textDetectionModel) {
                    // PyTorch ê¸°ë°˜ ë”¥ëŸ¬ë‹ OCR ì‚¬ìš©
                    loadingArea.innerHTML = `
                        <div class="loading-spinner"></div>
                        <p>ğŸ¤– AI ëª¨ë¸ë¡œ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                    `;

                    const ocrResult = await performDeepLearningOCR(imageCanvas);
                    finalText = ocrResult.text;
                    
                    // ì‹ ë¢°ë„ í‘œì‹œ
                    if (ocrResult.confidence > 0) {
                        const confidencePercent = Math.round(ocrResult.confidence * 100);
                        finalText += `\n\n[AI ì‹ ë¢°ë„: ${confidencePercent}%]`;
                    }
                } else {
                    // Tesseract í´ë°±
                    loadingArea.innerHTML = `
                        <div class="loading-spinner"></div>
                        <p>ğŸ“ Tesseractë¡œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                    `;

                    if (typeof Tesseract !== 'undefined') {
                        const { data: { text } } = await Tesseract.recognize(
                            imageCanvas,
                            selectedLanguage.replace('+', '+'),
                            {
                                tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                                preserve_interword_spaces: '1'
                            }
                        );
                        finalText = text;
                    } else {
                        throw new Error('OCR ì—”ì§„ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }

                loadingArea.style.display = 'none';
                resultArea.style.display = 'block';
                
                // í…ìŠ¤íŠ¸ í›„ì²˜ë¦¬
                let cleanedText = finalText.trim();
                if (cleanedText) {
                    cleanedText = cleanedText.replace(/\s+/g, ' ').replace(/\n\s*\n/g, '\n');
                }
                
                resultArea.value = cleanedText || 'í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì „ì²˜ë¦¬ ì˜µì…˜ì„ ì¡°ì •í•˜ê±°ë‚˜ ì´ë¯¸ì§€ í’ˆì§ˆì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                
                copyBtn.disabled = false;
                downloadBtn.disabled = false;
                
            } catch (error) {
                console.error('OCR Error:', error);
                loadingArea.style.display = 'none';
                resultArea.style.display = 'block';
                resultArea.value = 'í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n\nì˜¤ë¥˜: ' + error.message;
            }
            
            processBtn.disabled = false;
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë¸ ì´ˆê¸°í™” (ì¦‰ì‹œ ì‹¤í–‰)
        window.addEventListener('load', () => {
            // ì¦‰ì‹œ ì´ˆê¸°í™” ì‹œë„, ì‹¤íŒ¨ ì‹œ Tesseractë¡œ í´ë°±
            initializeModels();
        });

        clearBtn.addEventListener('click', () => {
            currentImage = null;
            processedImageData = null;
            imagePreview.innerHTML = '';
            resultArea.value = '';
            fileInput.value = '';
            processBtn.disabled = true;
            copyBtn.disabled = true;
            downloadBtn.disabled = true;
            loadingArea.style.display = 'none';
            resultArea.style.display = 'block';
            preprocessingOptions.style.display = 'none';
            previewCanvas.style.display = 'none';
        });

        copyBtn.addEventListener('click', async () => {
            if (resultArea.value) {
                try {
                    await navigator.clipboard.writeText(resultArea.value);
                    copyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                    setTimeout(() => {
                        copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬í•˜ê¸°';
                    }, 2000);
                } catch (err) {
                    // í´ë¦½ë³´ë“œ API ì‹¤íŒ¨ ì‹œ fallback
                    resultArea.select();
                    document.execCommand('copy');
                    copyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
                    setTimeout(() => {
                        copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬í•˜ê¸°';
                    }, 2000);
                }
            }
        });

        downloadBtn.addEventListener('click', () => {
            if (resultArea.value) {
                const blob = new Blob([resultArea.value], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ì¶”ì¶œëœí…ìŠ¤íŠ¸_${new Date().toLocaleDateString('ko-KR')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        });

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'v':
                        // Ctrl+Vë¡œ í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°
                        e.preventDefault();
                        navigator.clipboard.read().then(items => {
                            for (let item of items) {
                                if (item.types.includes('image/png') || item.types.includes('image/jpeg')) {
                                    item.getType('image/png').then(blob => {
                                        handleFile(blob);
                                    });
                                    break;
                                }
                            }
                        }).catch(err => {
                            console.log('í´ë¦½ë³´ë“œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                        });
                        break;
                    case 'Enter':
                        if (!processBtn.disabled) {
                            e.preventDefault();
                            processBtn.click();
                        }
                        break;
                }
            }
        });
    </script>
</body>
</html>